---
phase: 03-ideas-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/lib/ideas.ts
  - src/hooks/useIdeas.ts
autonomous: true

must_haves:
  truths:
    - "CRUD operations work for ideas"
    - "Real-time subscription updates ideas list when teammates add/delete"
    - "Toast notification appears when teammate adds an idea"
  artifacts:
    - path: "src/lib/ideas.ts"
      provides: "fetchIdeas, addIdea, deleteIdea functions"
      exports: ["fetchIdeas", "addIdea", "deleteIdea"]
    - path: "src/hooks/useIdeas.ts"
      provides: "useIdeas hook with real-time subscription"
      exports: ["useIdeas"]
  key_links:
    - from: "src/hooks/useIdeas.ts"
      to: "src/lib/ideas.ts"
      via: "import CRUD functions"
      pattern: "import.*from.*lib/ideas"
    - from: "src/hooks/useIdeas.ts"
      to: "supabase.channel"
      via: "postgres_changes subscription"
      pattern: "postgres_changes.*table.*ideas"
---

<objective>
Create the data layer for ideas: CRUD operations and a hook with real-time subscriptions.

Purpose: Enables reading, creating, and deleting ideas with automatic synchronization across team members (REQ-IDX-005). The hook follows the established useChannels pattern.

Output:
- lib/ideas.ts with fetchIdeas, addIdea, deleteIdea
- hooks/useIdeas.ts with state management and real-time updates
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-ideas-system/03-RESEARCH.md

# Existing patterns to follow exactly:
@src/lib/channels.ts
@src/hooks/useChannels.ts
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ideas CRUD operations</name>
  <files>src/lib/ideas.ts</files>
  <action>
Create lib/ideas.ts following the exact pattern from lib/channels.ts:

**fetchIdeas() -> Promise&lt;DbResult&lt;IdeaWithVideo[]&gt;&gt;:**
- Use Supabase nested select to join video and channel data in one query
- Order by created_at DESC (newest first per REQ-IDX-002)
- Query structure:
```typescript
.from('ideas')
.select(`
  *,
  video:videos (
    id,
    youtube_id,
    title,
    thumbnail_url,
    channel:channels (
      id,
      name
    )
  )
`)
.order('created_at', { ascending: false })
```
- Return typed as IdeaWithVideo[] (includes nested video/channel objects)

**addIdea(idea: IdeaInsert) -> Promise&lt;DbResult&lt;Idea&gt;&gt;:**
- Insert single idea
- Use .select().single() to return created record
- Handle errors (e.g., note too short will fail CHECK constraint)

**deleteIdea(id: string) -> Promise&lt;DbResult&lt;null&gt;&gt;:**
- Delete by id
- Return null data on success, error on failure

Import types from './types' and supabase client from './supabase'.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Types should compile. Manual verification: In browser console, import and call fetchIdeas() - should return empty array with no errors.
  </verify>
  <done>
- fetchIdeas returns IdeaWithVideo[] with nested video/channel data
- addIdea inserts and returns the new idea
- deleteIdea removes idea by id
- All functions handle errors gracefully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useIdeas hook with real-time</name>
  <files>src/hooks/useIdeas.ts</files>
  <action>
Create hooks/useIdeas.ts following the exact pattern from useChannels.ts:

**Interface UseIdeasResult:**
```typescript
{
  ideas: IdeaWithVideo[]
  isLoading: boolean
  error: string | null
  addIdea: (idea: IdeaInsert) => Promise<{ success: boolean; error?: string }>
  deleteIdea: (id: string) => Promise<{ success: boolean; error?: string }>
  refresh: () => Promise<void>
}
```

**Implementation:**
1. useState for ideas, isLoading, error
2. loadIdeas callback that calls fetchIdeas and updates state
3. useEffect that:
   - Calls loadIdeas on mount
   - Sets up real-time subscription with unique channel name: `ideas-realtime-${Date.now()}`
   - Subscribes to postgres_changes on 'ideas' table

**Real-time handler (CRITICAL - REQ-IDX-005):**
- On INSERT: Call fetchIdeas() to get full joined data (payload.new only has raw idea)
  - After refetch, find the new idea and show toast: `toast.info(\`New idea added by ${addedBy}\`)`
  - Only toast if addedBy is different from localStorage 'youtubeTracker_userName' (don't toast own actions)
- On DELETE: Filter out the deleted id from state: `setIdeas(prev => prev.filter(i => i.id !== payload.old.id))`

**Action handlers:**
- handleAddIdea: Call addIdea from lib, return success/error (real-time handles state update)
- handleDeleteIdea: Call deleteIdea from lib, return success/error (real-time handles state update)

**Cleanup:** Remove channel subscription on unmount.

Import toast from 'sonner' for teammate notifications.
  </action>
  <verify>
```bash
npx tsc --noEmit
```
Hook compiles. Manual test: Import useIdeas in a component, verify isLoading transitions and ideas array is empty.
  </verify>
  <done>
- useIdeas hook exports ideas, isLoading, error, addIdea, deleteIdea, refresh
- Real-time subscription updates state on INSERT/DELETE
- Toast appears when teammate adds idea (not for own additions)
- Cleanup removes subscription on unmount
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Hook can be imported: In a test component, `import { useIdeas } from '../hooks/useIdeas'`
3. Real-time pattern matches useChannels (unique channel name, cleanup on unmount)
</verification>

<success_criteria>
- lib/ideas.ts exports fetchIdeas, addIdea, deleteIdea with correct types
- useIdeas hook provides ideas array with full video/channel context
- Real-time subscription updates ideas automatically
- Teammate additions trigger info toast
</success_criteria>

<output>
After completion, create `.planning/phases/03-ideas-system/03-02-SUMMARY.md`
</output>

---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase.ts
  - src/lib/types.ts
  - supabase/migrations/001_create_channels.sql
autonomous: true
user_setup:
  - service: supabase
    why: "Database setup required"
    dashboard_config:
      - task: "Create new Supabase project (if not exists)"
        location: "https://supabase.com/dashboard -> New Project"
      - task: "Enable Realtime for channels table"
        location: "Database -> Replication -> Source -> channels table -> toggle ON"

must_haves:
  truths:
    - "Supabase client can connect"
    - "Channels table exists with correct schema"
    - "RLS policies allow public read"
    - "UNIQUE constraint prevents duplicate youtube_id"
  artifacts:
    - path: "src/lib/supabase.ts"
      provides: "Supabase client singleton"
      exports: ["supabase"]
      min_lines: 5
    - path: "src/lib/types.ts"
      provides: "TypeScript type definitions"
      exports: ["Channel"]
      min_lines: 10
    - path: "supabase/migrations/001_create_channels.sql"
      provides: "Database schema"
      contains: "CREATE TABLE channels"
  key_links:
    - from: "src/lib/supabase.ts"
      to: "import.meta.env"
      via: "environment variables"
      pattern: "import\\.meta\\.env\\.VITE_SUPABASE"
---

<objective>
Set up Supabase client singleton and create the channels table with RLS policies and UNIQUE constraint.

Purpose: Establishes the database layer that channel CRUD and real-time sync will use.
Output: Connected Supabase client, channels table ready for data, types defined.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Client and Types</name>
  <files>
    src/lib/supabase.ts
    src/lib/types.ts
  </files>
  <action>
    Create src/lib directory if not exists.

    Create src/lib/supabase.ts:
    ```typescript
    import { createClient } from '@supabase/supabase-js'

    const supabaseUrl = import.meta.env.VITE_SUPABASE_URL
    const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY

    if (!supabaseUrl || !supabaseAnonKey) {
      throw new Error(
        'Missing Supabase environment variables. ' +
        'Copy .env.example to .env.local and fill in your Supabase credentials.'
      )
    }

    export const supabase = createClient(supabaseUrl, supabaseAnonKey)
    ```

    Create src/lib/types.ts with Channel type matching database schema:
    ```typescript
    /**
     * Channel record from the channels table.
     * Represents a tracked YouTube channel.
     */
    export interface Channel {
      id: string                    // UUID primary key
      youtube_id: string            // YouTube channel ID (UC...)
      name: string                  // Channel display name
      thumbnail_url: string | null  // Channel avatar URL (88x88)
      subscriber_count: number | null // Subscriber count (can be hidden)
      added_by: string | null       // User who added (null for now, auth in v2)
      created_at: string            // ISO timestamp
    }

    /**
     * Data required to insert a new channel.
     * Omits auto-generated fields (id, created_at).
     */
    export interface ChannelInsert {
      youtube_id: string
      name: string
      thumbnail_url?: string | null
      subscriber_count?: number | null
      added_by?: string | null
    }

    /**
     * Database operation result type.
     */
    export interface DbResult<T> {
      data: T | null
      error: string | null
    }
    ```
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Files exist at correct paths
  </verify>
  <done>
    Supabase client singleton created, Channel type exported
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Database Migration SQL</name>
  <files>
    supabase/migrations/001_create_channels.sql
  </files>
  <action>
    Create supabase/migrations directory.

    Create supabase/migrations/001_create_channels.sql:
    ```sql
    -- Create channels table
    -- REQ-DM-001: id, youtube_id, name, thumbnail_url, subscriber_count, added_by, created_at

    CREATE TABLE IF NOT EXISTS channels (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      youtube_id TEXT NOT NULL,
      name TEXT NOT NULL,
      thumbnail_url TEXT,
      subscriber_count BIGINT,
      added_by UUID,  -- Will reference auth.users in v2
      created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

      -- REQ-CH-006: Prevent duplicate channel additions
      CONSTRAINT channels_youtube_id_unique UNIQUE (youtube_id)
    );

    -- Create index for faster lookups by youtube_id
    CREATE INDEX IF NOT EXISTS channels_youtube_id_idx ON channels (youtube_id);

    -- Create index for chronological ordering
    CREATE INDEX IF NOT EXISTS channels_created_at_idx ON channels (created_at DESC);

    -- Enable Row Level Security
    ALTER TABLE channels ENABLE ROW LEVEL SECURITY;

    -- RLS Policies

    -- Allow anyone to read channels (public data, no auth required for v1)
    CREATE POLICY "Channels are viewable by everyone"
    ON channels FOR SELECT
    TO public
    USING (true);

    -- Allow anyone to insert channels (no auth for v1)
    CREATE POLICY "Anyone can add channels"
    ON channels FOR INSERT
    TO public
    WITH CHECK (true);

    -- Allow anyone to delete channels (no auth for v1)
    CREATE POLICY "Anyone can delete channels"
    ON channels FOR DELETE
    TO public
    USING (true);

    -- Note: In v2 with auth, these policies will be restricted to authenticated users
    -- and delete will be restricted to the user who added the channel.

    -- Enable Realtime for this table (REQ-CH-005)
    -- This needs to be done in Supabase Dashboard: Database -> Replication -> Source
    -- Or via: ALTER PUBLICATION supabase_realtime ADD TABLE channels;
    ```

    This SQL should be run in Supabase Dashboard SQL Editor or via Supabase CLI.

    For immediate setup, also provide instructions:
    ```
    To apply this migration:
    1. Open Supabase Dashboard -> SQL Editor
    2. Paste the contents of supabase/migrations/001_create_channels.sql
    3. Click "Run"
    4. Go to Database -> Replication -> Source
    5. Enable replication for the "channels" table
    ```
  </action>
  <verify>
    Migration file exists at correct path
    SQL syntax is valid (no obvious errors)
  </verify>
  <done>
    Migration SQL created with channels table, indexes, RLS policies, and UNIQUE constraint
  </done>
</task>

<task type="auto">
  <name>Task 3: Test Supabase Connection</name>
  <files>
    src/App.tsx
  </files>
  <action>
    Temporarily update src/App.tsx to test the Supabase connection:
    ```typescript
    import { useEffect, useState } from 'react'
    import { Toaster, toast } from 'sonner'
    import { supabase } from './lib/supabase'

    export function App() {
      const [connectionStatus, setConnectionStatus] = useState<'checking' | 'connected' | 'error'>('checking')

      useEffect(() => {
        // Test connection by fetching from channels table
        async function testConnection() {
          try {
            const { error } = await supabase.from('channels').select('count').limit(1)

            if (error) {
              console.error('Supabase error:', error)
              // Table might not exist yet - that's expected
              if (error.message.includes('does not exist')) {
                toast.info('Channels table not created yet. Run the migration SQL.')
                setConnectionStatus('connected') // Connection works, just no table
              } else {
                toast.error(`Database error: ${error.message}`)
                setConnectionStatus('error')
              }
            } else {
              toast.success('Connected to Supabase!')
              setConnectionStatus('connected')
            }
          } catch (err) {
            console.error('Connection error:', err)
            toast.error('Failed to connect to Supabase. Check your .env.local file.')
            setConnectionStatus('error')
          }
        }

        testConnection()
      }, [])

      return (
        <div className="min-h-screen bg-[#0f0f0f] text-[#f1f1f1]">
          <main className="p-4">
            <h1 className="text-2xl font-bold">YouTube Competitor Tracker</h1>
            <p className="text-[#aaaaaa] mt-2">
              Supabase: {connectionStatus === 'checking' ? 'Checking...' :
                         connectionStatus === 'connected' ? 'Connected' : 'Error'}
            </p>
          </main>
          <Toaster position="bottom-right" theme="dark" richColors />
        </div>
      )
    }
    ```

    This temporary test will:
    1. Verify environment variables are loaded
    2. Verify Supabase client can connect
    3. Show connection status in UI
    4. Show toast for success/failure

    After verifying connection works, this test code can be removed or simplified in later plans.
  </action>
  <verify>
    Run `npm run dev`
    Check browser shows "Connected" or "Channels table not created yet" (both indicate connection works)
    Check browser console for any errors
    If error appears, verify .env.local has correct credentials
  </verify>
  <done>
    Supabase connection verified via browser test
  </done>
</task>

</tasks>

<verification>
1. `src/lib/supabase.ts` exports `supabase` client
2. `src/lib/types.ts` exports `Channel` and `ChannelInsert` types
3. `supabase/migrations/001_create_channels.sql` contains valid SQL
4. TypeScript compiles: `npx tsc --noEmit`
5. Browser shows Supabase connection status
</verification>

<success_criteria>
- Supabase client singleton created and exported
- Channel types match database schema
- Migration SQL ready for execution
- Connection test shows "Connected" status in browser
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>

---
phase: 01-foundation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/youtube.ts
  - src/lib/youtube.test.ts
autonomous: true

must_haves:
  truths:
    - "All 4 YouTube URL formats parse correctly"
    - "Invalid URLs return null"
    - "Raw channel IDs (UC...) are recognized"
  artifacts:
    - path: "src/lib/youtube.ts"
      provides: "YouTube URL parsing utility"
      exports: ["parseYouTubeChannelUrl"]
      min_lines: 25
    - path: "src/lib/youtube.test.ts"
      provides: "Test coverage for URL parser"
      contains: "describe"
      min_lines: 40
  key_links:
    - from: "src/lib/youtube.test.ts"
      to: "src/lib/youtube.ts"
      via: "import"
      pattern: "import.*parseYouTubeChannelUrl"
---

<objective>
Build a YouTube URL parser using TDD that extracts channel identifiers from multiple URL formats.

Purpose: REQ-CH-001 requires supporting /channel/, /@handle, /c/ formats and raw channel IDs. TDD ensures all edge cases are covered.
Output: Tested, reliable URL parser for the Add Channel feature.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<feature>
  <name>YouTube Channel URL Parser</name>
  <files>src/lib/youtube.ts, src/lib/youtube.test.ts</files>
  <behavior>
    parseYouTubeChannelUrl(input: string) -> { type: 'id' | 'handle' | 'custom', value: string } | null

    Supported formats:
    - /channel/UC... -> { type: 'id', value: 'UC...' }
    - /@handle -> { type: 'handle', value: 'handle' }
    - /c/CustomName -> { type: 'custom', value: 'CustomName' }
    - /user/Username -> { type: 'custom', value: 'Username' }
    - Raw UC... (24 chars) -> { type: 'id', value: 'UC...' }

    Edge cases:
    - Handles with dots/dashes: @mr.beast -> 'mr.beast'
    - URLs without https:// prefix
    - Trailing slashes
    - Query parameters (should be ignored)
    - Invalid URLs -> null
    - Empty string -> null

    Test cases:
    Input: "https://www.youtube.com/channel/UCX6OQ3DkcsbYNE6H8uQQuVA" -> { type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' }
    Input: "https://youtube.com/@MrBeast" -> { type: 'handle', value: 'MrBeast' }
    Input: "youtube.com/c/PewDiePie" -> { type: 'custom', value: 'PewDiePie' }
    Input: "UCX6OQ3DkcsbYNE6H8uQQuVA" -> { type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' }
    Input: "not-a-url" -> null
    Input: "" -> null
  </behavior>
  <implementation>
    Use URL API for parsing (handles edge cases).
    Regex patterns for path matching.
    Return null for any parsing failure (try/catch).
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>RED: Write Failing Tests</name>
  <files>
    src/lib/youtube.test.ts
    vitest.config.ts
    package.json
  </files>
  <action>
    Install Vitest for testing:
    ```bash
    npm install -D vitest @vitest/ui
    ```

    Add test script to package.json:
    ```json
    "scripts": {
      "test": "vitest",
      "test:ui": "vitest --ui"
    }
    ```

    Create vitest.config.ts:
    ```typescript
    import { defineConfig } from 'vitest/config'

    export default defineConfig({
      test: {
        globals: true,
        environment: 'node',
      },
    })
    ```

    Create src/lib/youtube.test.ts with comprehensive tests:
    ```typescript
    import { describe, it, expect } from 'vitest'
    import { parseYouTubeChannelUrl } from './youtube'

    describe('parseYouTubeChannelUrl', () => {
      describe('channel ID format (/channel/UC...)', () => {
        it('parses full URL with channel ID', () => {
          const result = parseYouTubeChannelUrl('https://www.youtube.com/channel/UCX6OQ3DkcsbYNE6H8uQQuVA')
          expect(result).toEqual({ type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' })
        })

        it('parses URL without www', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/channel/UCX6OQ3DkcsbYNE6H8uQQuVA')
          expect(result).toEqual({ type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' })
        })

        it('handles trailing slash', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/channel/UCX6OQ3DkcsbYNE6H8uQQuVA/')
          expect(result).toEqual({ type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' })
        })
      })

      describe('handle format (/@...)', () => {
        it('parses handle URL', () => {
          const result = parseYouTubeChannelUrl('https://www.youtube.com/@MrBeast')
          expect(result).toEqual({ type: 'handle', value: 'MrBeast' })
        })

        it('handles dots in handle', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/@mr.beast')
          expect(result).toEqual({ type: 'handle', value: 'mr.beast' })
        })

        it('handles underscores and dashes', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/@some_user-name')
          expect(result).toEqual({ type: 'handle', value: 'some_user-name' })
        })
      })

      describe('custom URL format (/c/...)', () => {
        it('parses custom URL', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/c/PewDiePie')
          expect(result).toEqual({ type: 'custom', value: 'PewDiePie' })
        })

        it('handles legacy /user/ format', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/user/PewDiePie')
          expect(result).toEqual({ type: 'custom', value: 'PewDiePie' })
        })
      })

      describe('raw channel ID', () => {
        it('parses raw channel ID starting with UC', () => {
          const result = parseYouTubeChannelUrl('UCX6OQ3DkcsbYNE6H8uQQuVA')
          expect(result).toEqual({ type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' })
        })

        it('handles channel ID with dashes', () => {
          const result = parseYouTubeChannelUrl('UC-lHJZR3Gqxm24_Vd_AJ5Yw')
          expect(result).toEqual({ type: 'id', value: 'UC-lHJZR3Gqxm24_Vd_AJ5Yw' })
        })
      })

      describe('URLs without protocol', () => {
        it('parses URL without https://', () => {
          const result = parseYouTubeChannelUrl('youtube.com/@MrBeast')
          expect(result).toEqual({ type: 'handle', value: 'MrBeast' })
        })

        it('parses URL with www but no protocol', () => {
          const result = parseYouTubeChannelUrl('www.youtube.com/channel/UCX6OQ3DkcsbYNE6H8uQQuVA')
          expect(result).toEqual({ type: 'id', value: 'UCX6OQ3DkcsbYNE6H8uQQuVA' })
        })
      })

      describe('edge cases and error handling', () => {
        it('ignores query parameters', () => {
          const result = parseYouTubeChannelUrl('https://youtube.com/@MrBeast?sub_confirmation=1')
          expect(result).toEqual({ type: 'handle', value: 'MrBeast' })
        })

        it('returns null for empty string', () => {
          expect(parseYouTubeChannelUrl('')).toBeNull()
        })

        it('returns null for random string', () => {
          expect(parseYouTubeChannelUrl('not-a-url')).toBeNull()
        })

        it('returns null for non-YouTube URL', () => {
          expect(parseYouTubeChannelUrl('https://vimeo.com/user123')).toBeNull()
        })

        it('returns null for YouTube video URL', () => {
          expect(parseYouTubeChannelUrl('https://youtube.com/watch?v=dQw4w9WgXcQ')).toBeNull()
        })

        it('returns null for YouTube shorts URL', () => {
          expect(parseYouTubeChannelUrl('https://youtube.com/shorts/abc123')).toBeNull()
        })
      })
    })
    ```

    Create stub src/lib/youtube.ts (to make imports work):
    ```typescript
    export function parseYouTubeChannelUrl(input: string): { type: 'id' | 'handle' | 'custom', value: string } | null {
      // TODO: Implement
      return null
    }
    ```

    Run tests to verify they fail: `npm test`
  </action>
  <verify>
    `npm test` runs and shows failing tests (all tests should fail except null cases)
    Test file imports successfully
  </verify>
  <done>
    Tests written and failing, stub function exists
  </done>
</task>

<task type="auto">
  <name>GREEN: Implement Parser to Pass Tests</name>
  <files>src/lib/youtube.ts</files>
  <action>
    Implement the full parser in src/lib/youtube.ts:
    ```typescript
    /**
     * Parses a YouTube channel URL or ID and extracts the channel identifier.
     *
     * Supported formats:
     * - https://youtube.com/channel/UC... -> { type: 'id', value: 'UC...' }
     * - https://youtube.com/@handle -> { type: 'handle', value: 'handle' }
     * - https://youtube.com/c/CustomName -> { type: 'custom', value: 'CustomName' }
     * - https://youtube.com/user/Username -> { type: 'custom', value: 'Username' }
     * - UC... (raw 24-char ID) -> { type: 'id', value: 'UC...' }
     *
     * @param input - YouTube URL or channel ID
     * @returns Parsed result or null if invalid
     */
    export function parseYouTubeChannelUrl(
      input: string
    ): { type: 'id' | 'handle' | 'custom'; value: string } | null {
      const trimmed = input.trim()

      if (!trimmed) {
        return null
      }

      // Check for raw channel ID (starts with UC, 24 chars total)
      if (/^UC[\w-]{22}$/.test(trimmed)) {
        return { type: 'id', value: trimmed }
      }

      try {
        // Add protocol if missing
        const urlString = trimmed.startsWith('http') ? trimmed : `https://${trimmed}`
        const url = new URL(urlString)

        // Verify it's a YouTube domain
        const hostname = url.hostname.toLowerCase()
        if (!hostname.includes('youtube.com') && !hostname.includes('youtu.be')) {
          return null
        }

        const path = url.pathname

        // /channel/UC... format (canonical channel ID)
        const channelMatch = path.match(/\/channel\/(UC[\w-]{22})/)
        if (channelMatch) {
          return { type: 'id', value: channelMatch[1] }
        }

        // /@handle format (modern handle)
        const handleMatch = path.match(/\/@([\w.-]+)/)
        if (handleMatch) {
          return { type: 'handle', value: handleMatch[1] }
        }

        // /c/customname format (custom URL)
        const customMatch = path.match(/\/c\/([\w.-]+)/)
        if (customMatch) {
          return { type: 'custom', value: customMatch[1] }
        }

        // /user/username format (legacy)
        const userMatch = path.match(/\/user\/([\w.-]+)/)
        if (userMatch) {
          return { type: 'custom', value: userMatch[1] }
        }

        // No recognized pattern
        return null
      } catch {
        // URL parsing failed
        return null
      }
    }
    ```

    Run tests: `npm test`
  </action>
  <verify>
    `npm test` shows all tests passing (green)
  </verify>
  <done>
    All tests pass, parser handles all formats correctly
  </done>
</task>

<task type="auto">
  <name>REFACTOR: Add Type Export and JSDoc</name>
  <files>src/lib/youtube.ts</files>
  <action>
    Add exported type for the result:
    ```typescript
    /**
     * Result of parsing a YouTube channel URL.
     * - 'id': Direct channel ID (UC...)
     * - 'handle': Modern handle (@username)
     * - 'custom': Custom URL (/c/name or /user/name)
     */
    export type YouTubeChannelParseResult = {
      type: 'id' | 'handle' | 'custom'
      value: string
    }

    // Update function signature to use the type
    export function parseYouTubeChannelUrl(input: string): YouTubeChannelParseResult | null {
      // ... implementation unchanged
    }
    ```

    Verify tests still pass: `npm test`
  </action>
  <verify>
    `npm test` still passes
    Type is exported and usable
  </verify>
  <done>
    Code refactored with exported type, all tests still pass
  </done>
</task>

</tasks>

<verification>
1. `npm test` passes with all green
2. Parser correctly handles all 4 URL formats
3. Parser returns null for invalid inputs
4. Type is exported: `YouTubeChannelParseResult`
5. Function is exported: `parseYouTubeChannelUrl`
</verification>

<success_criteria>
- All test cases pass
- parseYouTubeChannelUrl correctly parses:
  - /channel/UC... URLs
  - /@handle URLs
  - /c/custom URLs
  - /user/username URLs
  - Raw UC... channel IDs
- Invalid inputs return null
- YouTubeChannelParseResult type is exported
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>

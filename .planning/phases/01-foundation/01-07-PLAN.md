---
phase: 01-foundation
plan: 07
type: execute
wave: 3
depends_on: ["01-02", "01-04", "01-05", "01-06"]
files_modified:
  - src/components/AddChannelForm.tsx
  - src/pages/ChannelsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can paste a YouTube URL and add a channel"
    - "Invalid URLs show error toast"
    - "Duplicate channels show error toast"
    - "Successful add shows in grid via real-time"
    - "Delete removes channel and shows in real-time"
  artifacts:
    - path: "src/components/AddChannelForm.tsx"
      provides: "URL input form with validation"
      exports: ["AddChannelForm"]
      min_lines: 50
    - path: "src/pages/ChannelsPage.tsx"
      provides: "Complete channels page"
      contains: "useChannels"
      min_lines: 40
  key_links:
    - from: "src/components/AddChannelForm.tsx"
      to: "src/lib/youtube.ts"
      via: "URL parsing"
      pattern: "parseYouTubeChannelUrl"
    - from: "src/pages/ChannelsPage.tsx"
      to: "src/hooks/useChannels.ts"
      via: "hook usage"
      pattern: "useChannels"
    - from: "src/pages/ChannelsPage.tsx"
      to: "src/components/ChannelGrid.tsx"
      via: "component render"
      pattern: "ChannelGrid"
---

<objective>
Create the AddChannelForm component and integrate all parts in ChannelsPage for the complete channel management flow.

Purpose: REQ-CH-001 (add by URL), REQ-CH-007 (error toast for invalid URLs), complete the channel CRUD UI.
Output: Working add channel form, integrated ChannelsPage with real-time updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md (URL parser)
@.planning/phases/01-foundation/01-05-SUMMARY.md (useChannels hook)
@.planning/phases/01-foundation/01-06-SUMMARY.md (UI components)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddChannelForm Component</name>
  <files>
    src/components/AddChannelForm.tsx
  </files>
  <action>
    Create src/components/AddChannelForm.tsx:
    ```typescript
    import { useState, type FormEvent } from 'react'
    import { toast } from 'sonner'
    import { parseYouTubeChannelUrl } from '../lib/youtube'
    import type { ChannelInsert } from '../lib/types'

    interface AddChannelFormProps {
      onAdd: (channel: ChannelInsert) => Promise<{ success: boolean; error?: string }>
      disabled?: boolean
    }

    /**
     * Form for adding a YouTube channel by URL.
     * Validates URL format and calls onAdd with parsed channel data.
     * REQ-CH-001: Supports /channel/, /@handle, /c/, and raw channel ID formats.
     */
    export function AddChannelForm({ onAdd, disabled = false }: AddChannelFormProps) {
      const [url, setUrl] = useState('')
      const [isSubmitting, setIsSubmitting] = useState(false)

      const handleSubmit = async (e: FormEvent) => {
        e.preventDefault()

        if (!url.trim()) {
          toast.error('Please enter a YouTube channel URL')
          return
        }

        // Parse the URL to extract channel info
        const parsed = parseYouTubeChannelUrl(url)

        if (!parsed) {
          toast.error('Invalid YouTube channel URL. Please use a valid channel, handle, or custom URL.')
          return
        }

        setIsSubmitting(true)

        try {
          // For now, we'll use the parsed value as both youtube_id and name
          // In Phase 2, we'll fetch actual channel details from YouTube API
          const channelData: ChannelInsert = {
            youtube_id: parsed.type === 'id' ? parsed.value : parsed.value, // Will be resolved in Phase 2
            name: parsed.type === 'id' ? `Channel ${parsed.value.slice(0, 8)}...` : `@${parsed.value}`,
            thumbnail_url: null, // Will be fetched in Phase 2
            subscriber_count: null, // Will be fetched in Phase 2
          }

          // If it's a direct channel ID, use it
          // If it's a handle/custom, we need to note this for Phase 2 resolution
          // For Phase 1, we'll accept the limitation and store the identifier

          const result = await onAdd(channelData)

          if (result.success) {
            toast.success(`Channel added: ${channelData.name}`)
            setUrl('')
          } else {
            toast.error(result.error || 'Failed to add channel')
          }
        } catch (error) {
          console.error('Error adding channel:', error)
          toast.error('An unexpected error occurred')
        } finally {
          setIsSubmitting(false)
        }
      }

      return (
        <form onSubmit={handleSubmit} className="flex gap-2">
          <div className="relative flex-1">
            <input
              type="text"
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              placeholder="Paste YouTube channel URL (e.g., youtube.com/@MrBeast)"
              disabled={disabled || isSubmitting}
              className="w-full px-4 py-2 bg-[#272727] border border-[#3f3f3f] rounded-lg text-[#f1f1f1] placeholder-[#aaaaaa] focus:outline-none focus:border-[#aaaaaa] disabled:opacity-50 disabled:cursor-not-allowed"
            />
            {url && (
              <button
                type="button"
                onClick={() => setUrl('')}
                className="absolute right-3 top-1/2 -translate-y-1/2 text-[#aaaaaa] hover:text-[#f1f1f1]"
                aria-label="Clear input"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            )}
          </div>

          <button
            type="submit"
            disabled={disabled || isSubmitting || !url.trim()}
            className="px-6 py-2 bg-red-600 hover:bg-red-500 disabled:bg-red-900 disabled:cursor-not-allowed text-white font-medium rounded-lg transition-colors flex items-center gap-2"
          >
            {isSubmitting ? (
              <>
                <svg className="w-4 h-4 animate-spin" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
                </svg>
                Adding...
              </>
            ) : (
              <>
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                </svg>
                Add Channel
              </>
            )}
          </button>
        </form>
      )
    }
    ```
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Component exports AddChannelForm
  </verify>
  <done>
    AddChannelForm created with URL validation, loading state, and toast notifications
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Components in ChannelsPage</name>
  <files>
    src/pages/ChannelsPage.tsx
  </files>
  <action>
    Update src/pages/ChannelsPage.tsx to use all components:
    ```typescript
    import { toast } from 'sonner'
    import { useChannels } from '../hooks/useChannels'
    import { AddChannelForm } from '../components/AddChannelForm'
    import { ChannelGrid } from '../components/ChannelGrid'

    /**
     * Main channels page with add form and channel grid.
     * Uses real-time sync for instant updates across tabs/users.
     */
    export function ChannelsPage() {
      const { channels, isLoading, error, addChannel, deleteChannel } = useChannels()

      const handleDeleteChannel = async (id: string) => {
        const channel = channels.find(c => c.id === id)
        const result = await deleteChannel(id)

        if (result.success) {
          toast.success(`Deleted: ${channel?.name || 'Channel'}`)
        } else {
          toast.error(result.error || 'Failed to delete channel')
        }
      }

      return (
        <div className="max-w-7xl mx-auto p-4">
          {/* Header with Add Form */}
          <div className="mb-6">
            <h1 className="text-2xl font-bold mb-4">Channels</h1>
            <AddChannelForm onAdd={addChannel} disabled={isLoading} />
          </div>

          {/* Error State */}
          {error && (
            <div className="mb-4 p-4 bg-red-900/20 border border-red-600 rounded-lg text-red-400">
              <p>Error loading channels: {error}</p>
              <button
                onClick={() => window.location.reload()}
                className="mt-2 text-sm underline hover:no-underline"
              >
                Refresh page
              </button>
            </div>
          )}

          {/* Loading State */}
          {isLoading && (
            <div className="flex items-center justify-center py-12">
              <svg className="w-8 h-8 animate-spin text-red-600" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
              <span className="ml-2 text-[#aaaaaa]">Loading channels...</span>
            </div>
          )}

          {/* Channel Grid */}
          {!isLoading && !error && (
            <ChannelGrid channels={channels} onDeleteChannel={handleDeleteChannel} />
          )}

          {/* Real-time indicator */}
          {!isLoading && !error && channels.length > 0 && (
            <div className="mt-6 text-center">
              <span className="inline-flex items-center gap-2 text-xs text-[#aaaaaa]">
                <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                Real-time sync active
              </span>
            </div>
          )}
        </div>
      )
    }
    ```
  </action>
  <verify>
    Run `npm run dev`
    Navigate to http://localhost:5173/
    Verify:
    - Add form visible at top
    - Empty state shows if no channels
    - Can paste URL and click "Add Channel"
    - Invalid URL shows error toast
    - (If DB set up) Channel appears in grid
  </verify>
  <done>
    ChannelsPage integrates AddChannelForm, ChannelGrid, useChannels with loading/error states
  </done>
</task>

</tasks>

<verification>
1. AddChannelForm validates URLs using parseYouTubeChannelUrl
2. Invalid URLs show error toast (REQ-CH-007)
3. Duplicate channel attempts show error toast (REQ-CH-006)
4. ChannelsPage uses useChannels hook
5. Channel grid shows added channels
6. Delete button triggers confirmation, then removes channel
7. Real-time sync indicator visible
8. No TypeScript errors
</verification>

<success_criteria>
- User can add channel by pasting URL (REQ-CH-001)
- All 4 URL formats work (/channel/, /@, /c/, raw ID)
- Invalid URLs show descriptive error toast (REQ-CH-007)
- Duplicate channels prevented with error message (REQ-CH-006)
- Channel appears in grid after add (via real-time)
- Delete removes channel with confirmation (REQ-CH-004)
- Real-time sync visible to user
- Loading and error states handled gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-07-SUMMARY.md`
</output>

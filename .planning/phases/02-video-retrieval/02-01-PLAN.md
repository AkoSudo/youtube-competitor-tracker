---
phase: 02-video-retrieval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/002_create_videos.sql
  - src/lib/types.ts
  - src/lib/formatters.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Video durations display in MM:SS format (e.g., 3:05, 1:01:01)"
    - "Video view counts display with compact notation (e.g., 1.2M, 500K)"
    - "Video publish dates show relative time (e.g., 2 days ago)"
    - "Videos can be stored and retrieved from database with channel relationship"
  artifacts:
    - path: "supabase/migrations/002_create_videos.sql"
      provides: "Videos table with foreign key to channels"
      contains: "CREATE TABLE videos"
    - path: "src/lib/types.ts"
      provides: "Video and VideoInsert interfaces"
      exports: ["Video", "VideoInsert"]
    - path: "src/lib/formatters.ts"
      provides: "View count, duration, date formatting utilities"
      exports: ["formatViewCount", "formatDuration", "formatRelativeDate"]
  key_links:
    - from: "supabase/migrations/002_create_videos.sql"
      to: "channels table"
      via: "channel_id REFERENCES channels(id)"
      pattern: "REFERENCES channels"
---

<objective>
Create videos database schema, TypeScript types, and formatting utilities.

Purpose: Foundation for video data storage and display. Videos table with foreign key to channels enables cascade delete. Formatters provide consistent view counts (1.2M), durations (15:33), and relative dates (2 days ago).

Output: videos migration, Video types, and formatter utilities ready for Edge Function and UI components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-video-retrieval/02-RESEARCH.md

# Existing files to extend
@src/lib/types.ts
@supabase/migrations/001_create_channels.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create videos table migration</name>
  <files>supabase/migrations/002_create_videos.sql</files>
  <action>
Create migration for videos table following the existing channels migration pattern:

```sql
CREATE TABLE videos (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  channel_id UUID NOT NULL REFERENCES channels(id) ON DELETE CASCADE,
  youtube_id TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  thumbnail_url TEXT NOT NULL,
  duration_seconds INTEGER NOT NULL,
  view_count BIGINT NOT NULL,
  published_at TIMESTAMPTZ NOT NULL,
  fetched_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes for query patterns
CREATE INDEX videos_channel_id_idx ON videos(channel_id);
CREATE INDEX videos_published_at_idx ON videos(published_at DESC);
CREATE INDEX videos_fetched_at_idx ON videos(fetched_at DESC);
CREATE INDEX videos_duration_seconds_idx ON videos(duration_seconds);

-- RLS policies (public read/write for v1 - no auth)
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;

CREATE POLICY "videos_select_policy" ON videos FOR SELECT USING (true);
CREATE POLICY "videos_insert_policy" ON videos FOR INSERT WITH CHECK (true);
CREATE POLICY "videos_update_policy" ON videos FOR UPDATE USING (true);
CREATE POLICY "videos_delete_policy" ON videos FOR DELETE USING (true);
```

Use UUID for id (consistent with channels), UNIQUE on youtube_id for upsert support.
ON DELETE CASCADE ensures videos are deleted when channel is removed.
  </action>
  <verify>Run `supabase db reset` or apply migration manually in Supabase dashboard. Confirm videos table exists with correct columns and constraints.</verify>
  <done>videos table created with channel_id FK, youtube_id unique constraint, indexes, and RLS policies.</done>
</task>

<task type="auto">
  <name>Task 2: Add Video types to types.ts</name>
  <files>src/lib/types.ts</files>
  <action>
Add Video and VideoInsert interfaces to existing types.ts file:

```typescript
/**
 * Video record from the videos table.
 * Represents a YouTube video from a tracked channel.
 */
export interface Video {
  id: string                    // UUID primary key
  channel_id: string            // FK to channels.id
  youtube_id: string            // YouTube video ID
  title: string                 // Video title
  thumbnail_url: string         // Medium thumbnail (320x180)
  duration_seconds: number      // Duration in seconds (>= 180 for long-form)
  view_count: number            // View count
  published_at: string          // ISO timestamp
  fetched_at: string            // When we last fetched from YouTube API
  created_at: string            // When we first stored this video
}

/**
 * Data required to insert/upsert a video.
 * Omits auto-generated fields (id, created_at).
 */
export interface VideoInsert {
  channel_id: string
  youtube_id: string
  title: string
  thumbnail_url: string
  duration_seconds: number
  view_count: number
  published_at: string
  fetched_at: string
}
```

Keep existing Channel and ChannelInsert types unchanged.
  </action>
  <verify>`npm run build` succeeds with no type errors.</verify>
  <done>Video and VideoInsert types exported from src/lib/types.ts.</done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies and create formatters</name>
  <files>package.json, src/lib/formatters.ts</files>
  <action>
Install dependencies:
```bash
npm install date-fns iso8601-duration
```

Create src/lib/formatters.ts with three formatters:

```typescript
import { formatDistanceToNow } from 'date-fns'

/**
 * Format large numbers with K/M/B suffixes.
 * Uses native Intl.NumberFormat for locale-aware formatting.
 * Examples: 1234 -> "1.2K", 1500000 -> "1.5M"
 */
export function formatViewCount(count: number): string {
  return new Intl.NumberFormat('en-US', {
    notation: 'compact',
    compactDisplay: 'short',
    maximumFractionDigits: 1,
  }).format(count)
}

/**
 * Format duration in seconds to MM:SS or HH:MM:SS format.
 * Examples: 185 -> "3:05", 3661 -> "1:01:01"
 */
export function formatDuration(seconds: number): string {
  const hours = Math.floor(seconds / 3600)
  const minutes = Math.floor((seconds % 3600) / 60)
  const secs = seconds % 60

  if (hours > 0) {
    return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
  }
  return `${minutes}:${secs.toString().padStart(2, '0')}`
}

/**
 * Format date as relative time ("2 days ago", "1 month ago").
 * Uses date-fns formatDistanceToNow for human-readable output.
 */
export function formatRelativeDate(dateString: string): string {
  return formatDistanceToNow(new Date(dateString), { addSuffix: true })
}
```

Note: iso8601-duration is installed for Edge Function use (server-side), not needed in client bundle.
  </action>
  <verify>
`npm run build` succeeds.
Test formatters in browser console or write quick test:
- formatViewCount(1234567) should return "1.2M"
- formatDuration(185) should return "3:05"
- formatRelativeDate(yesterday's date) should return "1 day ago"
  </verify>
  <done>date-fns installed, formatters.ts created with formatViewCount, formatDuration, formatRelativeDate functions.</done>
</task>

</tasks>

<verification>
- [ ] `supabase/migrations/002_create_videos.sql` exists with valid SQL
- [ ] videos table has channel_id FK with ON DELETE CASCADE
- [ ] youtube_id has UNIQUE constraint
- [ ] Video and VideoInsert types exported from src/lib/types.ts
- [ ] date-fns in package.json dependencies
- [ ] iso8601-duration in package.json dependencies
- [ ] formatters.ts exports formatViewCount, formatDuration, formatRelativeDate
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
Foundation layer complete: database schema, types, and formatters ready for Edge Function (plan 02) and UI components (plan 04).
</success_criteria>

<output>
After completion, create `.planning/phases/02-video-retrieval/02-01-SUMMARY.md`
</output>

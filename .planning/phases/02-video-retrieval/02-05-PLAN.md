---
phase: 02-video-retrieval
plan: 05
type: execute
wave: 3
depends_on: ["02-01", "02-03", "02-04"]
files_modified:
  - src/pages/ChannelDetailPage.tsx
  - src/App.tsx
  - src/components/ChannelCard.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a channel navigates to channel detail page"
    - "Channel detail page shows channel info and videos"
    - "Videos load with loading indicator"
    - "Refresh button triggers fresh fetch from YouTube API"
    - "Last updated timestamp displays"
    - "Back navigation returns to channels list"
  artifacts:
    - path: "src/pages/ChannelDetailPage.tsx"
      provides: "Channel detail page with videos"
      exports: ["ChannelDetailPage"]
    - path: "src/App.tsx"
      provides: "Route for channel detail"
      contains: "/channels/:id"
  key_links:
    - from: "src/pages/ChannelDetailPage.tsx"
      to: "src/hooks/useChannelVideos.ts"
      via: "import useChannelVideos"
      pattern: "import.*useChannelVideos"
    - from: "src/pages/ChannelDetailPage.tsx"
      to: "src/components/VideoGrid.tsx"
      via: "import VideoGrid"
      pattern: "import.*VideoGrid"
    - from: "src/components/ChannelCard.tsx"
      to: "src/pages/ChannelDetailPage.tsx"
      via: "Link navigation"
      pattern: "to=.*channels/"
---

<objective>
Create channel detail page with video display and integrate navigation from channel cards.

Purpose: Completes the video retrieval flow. User clicks channel card -> navigates to detail page -> sees videos with refresh capability. REQ-VID-006 satisfied with refresh button and timestamp.

Output: Working end-to-end flow from channel list to channel videos display.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-video-retrieval/02-RESEARCH.md

# Components and hooks from earlier plans
@src/hooks/useChannelVideos.ts
@src/components/VideoGrid.tsx
@src/lib/formatters.ts

# Existing routing and components
@src/App.tsx
@src/components/ChannelCard.tsx
@src/hooks/useChannels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChannelDetailPage</name>
  <files>src/pages/ChannelDetailPage.tsx</files>
  <action>
Create src/pages/ChannelDetailPage.tsx:

```tsx
import { useParams, Link } from 'react-router'
import { useState, useEffect } from 'react'
import { toast } from 'sonner'
import { supabase } from '../lib/supabase'
import { useChannelVideos } from '../hooks/useChannelVideos'
import { VideoGrid } from '../components/VideoGrid'
import { formatRelativeDate } from '../lib/formatters'
import type { Channel, Video } from '../lib/types'

/**
 * Channel detail page showing channel info and videos.
 * REQ-VID-003: Display top 20 long-form videos sorted by newest
 * REQ-VID-006: Manual refresh with last updated timestamp
 */
export function ChannelDetailPage() {
  const { id } = useParams<{ id: string }>()
  const [channel, setChannel] = useState<Channel | null>(null)
  const [channelLoading, setChannelLoading] = useState(true)

  const { videos, isLoading, error, cached, fetchedAt, refresh } = useChannelVideos(
    id || null,
    channel?.youtube_id || null
  )

  // Fetch channel details
  useEffect(() => {
    async function loadChannel() {
      if (!id) return

      setChannelLoading(true)
      const { data, error } = await supabase
        .from('channels')
        .select('*')
        .eq('id', id)
        .single()

      if (error) {
        toast.error('Failed to load channel')
      } else {
        setChannel(data)
      }
      setChannelLoading(false)
    }

    loadChannel()
  }, [id])

  const handleRefresh = async () => {
    toast.promise(refresh(), {
      loading: 'Refreshing videos...',
      success: 'Videos refreshed!',
      error: 'Failed to refresh videos',
    })
  }

  const handleSaveIdea = (video: Video) => {
    // Phase 3: Will open Save Idea modal
    toast.info('Save Idea feature coming in Phase 3!')
  }

  // Loading state for channel
  if (channelLoading) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div className="animate-pulse">
          <div className="h-8 bg-[#272727] rounded w-48 mb-4"></div>
          <div className="h-4 bg-[#272727] rounded w-32"></div>
        </div>
      </div>
    )
  }

  // Channel not found
  if (!channel) {
    return (
      <div className="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div className="text-center py-12">
          <h1 className="text-2xl font-bold text-[#f1f1f1] mb-4">Channel not found</h1>
          <Link
            to="/"
            className="text-red-500 hover:text-red-400 underline"
          >
            Back to Channels
          </Link>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 py-8">
      {/* Back link */}
      <Link
        to="/"
        className="inline-flex items-center text-[#aaaaaa] hover:text-white mb-6 transition-colors"
      >
        <svg
          className="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M15 19l-7-7 7-7"
          />
        </svg>
        Back to Channels
      </Link>

      {/* Channel header */}
      <div className="flex items-center gap-4 mb-8">
        {channel.thumbnail_url ? (
          <img
            src={channel.thumbnail_url}
            alt={channel.name}
            className="w-16 h-16 rounded-full object-cover"
          />
        ) : (
          <div className="w-16 h-16 rounded-full bg-[#272727] flex items-center justify-center">
            <span className="text-xl text-[#aaaaaa]">
              {channel.name.charAt(0).toUpperCase()}
            </span>
          </div>
        )}
        <div>
          <h1 className="text-2xl font-bold text-[#f1f1f1]">{channel.name}</h1>
          {channel.subscriber_count !== null && (
            <p className="text-[#aaaaaa]">
              {new Intl.NumberFormat('en-US', {
                notation: 'compact',
                compactDisplay: 'short',
              }).format(channel.subscriber_count)}{' '}
              subscribers
            </p>
          )}
        </div>
      </div>

      {/* Videos header with refresh */}
      <div className="flex items-center justify-between mb-6">
        <div>
          <h2 className="text-xl font-semibold text-[#f1f1f1]">Recent Videos</h2>
          {fetchedAt && (
            <p className="text-xs text-[#aaaaaa] mt-1">
              {cached ? 'From cache' : 'Fresh'} â€¢ Last updated {formatRelativeDate(fetchedAt)}
            </p>
          )}
        </div>
        <button
          onClick={handleRefresh}
          disabled={isLoading}
          className="flex items-center gap-2 px-4 py-2 rounded-lg bg-[#272727] hover:bg-[#3f3f3f] disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          <svg
            className={`w-4 h-4 ${isLoading ? 'animate-spin' : ''}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
          {isLoading ? 'Refreshing...' : 'Refresh'}
        </button>
      </div>

      {/* Error state */}
      {error && (
        <div className="bg-red-500/10 border border-red-500/50 rounded-lg p-4 mb-6">
          <p className="text-red-500">{error}</p>
        </div>
      )}

      {/* Videos grid */}
      {isLoading && videos.length === 0 ? (
        <div className="grid grid-cols-[repeat(auto-fit,minmax(280px,1fr))] gap-6">
          {[...Array(6)].map((_, i) => (
            <div key={i} className="animate-pulse">
              <div className="aspect-video bg-[#272727] rounded-xl"></div>
              <div className="mt-3 space-y-2">
                <div className="h-4 bg-[#272727] rounded w-full"></div>
                <div className="h-4 bg-[#272727] rounded w-3/4"></div>
                <div className="h-3 bg-[#272727] rounded w-1/2"></div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <VideoGrid
          videos={videos}
          onSaveIdea={handleSaveIdea}
          emptyMessage="No videos found. Try refreshing or check if the channel has recent long-form content."
        />
      )}
    </div>
  )
}
```

Key implementation:
- Fetches channel by ID from URL params
- Uses useChannelVideos hook for videos
- Shows loading skeleton while fetching
- Displays cache status and last updated timestamp
- Refresh button with loading spinner
- Error display with red styling
- Back navigation to channels list
- Passes onSaveIdea to VideoGrid (placeholder for Phase 3)
  </action>
  <verify>`npm run build` succeeds.</verify>
  <done>ChannelDetailPage created with channel header, video grid, refresh button, and cache status.</done>
</task>

<task type="auto">
  <name>Task 2: Add route to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Update src/App.tsx to add route for channel detail page:

```tsx
import { BrowserRouter, Routes, Route } from 'react-router'
import { Toaster } from 'sonner'
import { Nav } from './components/Nav'
import { ChannelsPage } from './pages/ChannelsPage'
import { ChannelDetailPage } from './pages/ChannelDetailPage'
import { IdeasPage } from './pages/IdeasPage'

export function App() {
  // TODO: Get actual ideas count from state/API in Phase 3
  const ideasCount = 0

  return (
    <BrowserRouter>
      <div className="min-h-screen bg-[#0f0f0f] text-[#f1f1f1]">
        <Nav ideasCount={ideasCount} />

        <main>
          <Routes>
            <Route path="/" element={<ChannelsPage />} />
            <Route path="/channels/:id" element={<ChannelDetailPage />} />
            <Route path="/ideas" element={<IdeasPage />} />
          </Routes>
        </main>

        <Toaster position="bottom-right" theme="dark" richColors />
      </div>
    </BrowserRouter>
  )
}
```

Only change: Add import for ChannelDetailPage and add route `/channels/:id`.
  </action>
  <verify>`npm run build` succeeds. Route exists at /channels/:id.</verify>
  <done>Route added for channel detail page.</done>
</task>

<task type="auto">
  <name>Task 3: Make ChannelCard clickable</name>
  <files>src/components/ChannelCard.tsx</files>
  <action>
Update src/components/ChannelCard.tsx to navigate to channel detail page on click:

Wrap the card content (except delete button) in a Link:

```tsx
import { useRef } from 'react'
import { Link } from 'react-router'
import type { Channel } from '../lib/types'
import { ConfirmDialog, type ConfirmDialogRef } from './ConfirmDialog'

interface ChannelCardProps {
  channel: Channel
  onDelete: (id: string) => void
}

/**
 * Displays a single channel with thumbnail, name, subscribers, and delete button.
 * REQ-CH-003: thumbnail (88x88), name, subscriber count, added by, created date
 * Clicking navigates to channel detail page to view videos.
 */
export function ChannelCard({ channel, onDelete }: ChannelCardProps) {
  const dialogRef = useRef<ConfirmDialogRef>(null)

  const handleDeleteClick = (e: React.MouseEvent) => {
    e.preventDefault() // Prevent link navigation
    e.stopPropagation()
    dialogRef.current?.open()
  }

  const handleConfirmDelete = () => {
    onDelete(channel.id)
  }

  // Format subscriber count (e.g., 1.2M, 500K)
  const formatSubscribers = (count: number | null): string => {
    if (count === null) return 'Hidden'
    if (count >= 1_000_000) return `${(count / 1_000_000).toFixed(1)}M`
    if (count >= 1_000) return `${(count / 1_000).toFixed(0)}K`
    return count.toString()
  }

  // Format date as relative or absolute
  const formatDate = (dateString: string): string => {
    const date = new Date(dateString)
    const now = new Date()
    const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24))

    if (diffDays === 0) return 'Today'
    if (diffDays === 1) return 'Yesterday'
    if (diffDays < 7) return `${diffDays} days ago`
    return date.toLocaleDateString()
  }

  return (
    <>
      <Link
        to={`/channels/${channel.id}`}
        className="block bg-[#272727] rounded-xl p-4 hover:bg-[#3f3f3f] transition-colors group"
      >
        <div className="flex items-start gap-4">
          {/* Thumbnail */}
          <div className="flex-shrink-0">
            {channel.thumbnail_url ? (
              <img
                src={channel.thumbnail_url}
                alt={`${channel.name} thumbnail`}
                className="w-[88px] h-[88px] rounded-full object-cover"
              />
            ) : (
              <div className="w-[88px] h-[88px] rounded-full bg-[#3f3f3f] flex items-center justify-center">
                <span className="text-2xl text-[#aaaaaa]">
                  {channel.name.charAt(0).toUpperCase()}
                </span>
              </div>
            )}
          </div>

          {/* Info */}
          <div className="flex-1 min-w-0">
            <h3 className="font-semibold text-lg truncate" title={channel.name}>
              {channel.name}
            </h3>

            <p className="text-[#aaaaaa] text-sm mt-1">
              {formatSubscribers(channel.subscriber_count)} subscribers
            </p>

            <p className="text-[#aaaaaa] text-xs mt-2">
              Added {formatDate(channel.created_at)}
              {channel.added_by && ` by ${channel.added_by}`}
            </p>
          </div>

          {/* Delete button */}
          <button
            onClick={handleDeleteClick}
            className="opacity-0 group-hover:opacity-100 p-2 rounded-lg hover:bg-[#4f4f4f] transition-all"
            aria-label={`Delete ${channel.name}`}
          >
            <svg
              className="w-5 h-5 text-[#aaaaaa] hover:text-red-500"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
              />
            </svg>
          </button>
        </div>
      </Link>

      <ConfirmDialog
        ref={dialogRef}
        title="Delete Channel"
        message={`Are you sure you want to delete "${channel.name}"? This will also delete all videos and ideas from this channel.`}
        confirmLabel="Delete"
        cancelLabel="Cancel"
        confirmVariant="danger"
        onConfirm={handleConfirmDelete}
      />
    </>
  )
}
```

Changes:
- Import Link from react-router
- Wrap card content in Link to `/channels/${channel.id}`
- Changed outer div to Link element
- Delete button prevents link navigation with e.preventDefault()
  </action>
  <verify>`npm run build` succeeds. Clicking channel card navigates to detail page.</verify>
  <done>ChannelCard now navigates to channel detail page on click.</done>
</task>

</tasks>

<verification>
- [ ] src/pages/ChannelDetailPage.tsx exists
- [ ] Route /channels/:id defined in App.tsx
- [ ] Clicking ChannelCard navigates to detail page
- [ ] ChannelDetailPage displays channel info and videos
- [ ] Loading skeleton shown while fetching
- [ ] Refresh button triggers fresh fetch
- [ ] Cache status and last updated timestamp displayed
- [ ] Back link returns to channels list
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
End-to-end video retrieval flow complete. User can click channel, see videos, and refresh. Ready for Phase 3 Save Idea integration.
</success_criteria>

<output>
After completion, create `.planning/phases/02-video-retrieval/02-05-SUMMARY.md`
</output>

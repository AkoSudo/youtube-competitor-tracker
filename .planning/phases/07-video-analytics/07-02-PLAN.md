---
phase: 07-video-analytics
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/pages/AnalyticsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can sort videos by most recent (publish date)"
    - "User can sort videos by most views"
    - "User can toggle sort direction (ascending/descending)"
    - "Sort selection persists during session (survives page navigation)"
    - "User can filter by time period (7d, 30d, 90d, all time)"
    - "Default time period is 30 days"
    - "Time filter applies to videos section"
    - "Filtered view shows video count"
  artifacts:
    - path: "src/pages/AnalyticsPage.tsx"
      provides: "Analytics page with sorting and filtering"
      min_lines: 100
  key_links:
    - from: "src/pages/AnalyticsPage.tsx"
      to: "src/hooks/useSessionState.ts"
      via: "hook import for persisted state"
      pattern: "useSessionState.*sortField|sortDirection|timePeriod"
    - from: "src/pages/AnalyticsPage.tsx"
      to: "src/components/SortFilterControls.tsx"
      via: "component import for UI controls"
      pattern: "<SortFilterControls"
    - from: "src/pages/AnalyticsPage.tsx"
      to: "date-fns"
      via: "subDays, isAfter for time filtering"
      pattern: "import.*from 'date-fns'"
---

<objective>
Integrate sorting and time filtering into the Analytics page.

Purpose: Enable users to sort videos by date or views with direction control, filter by time period (7d/30d/90d/all), and see these preferences persist during their session.

Output: Updated AnalyticsPage.tsx with sort/filter controls, filtered video list, and session-persisted state.
</objective>

<execution_context>
@/Users/thihaaung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/thihaaung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-video-analytics/07-RESEARCH.md
@.planning/phases/07-video-analytics/07-01-SUMMARY.md
@src/pages/AnalyticsPage.tsx (current implementation)
@src/hooks/useSessionState.ts (from Plan 07-01)
@src/components/SortFilterControls.tsx (from Plan 07-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sort/filter state with session persistence</name>
  <files>src/pages/AnalyticsPage.tsx</files>
  <action>
Add session-persisted state for sorting and filtering.

Imports to add:
```typescript
import { useSessionState } from '../hooks/useSessionState'
import { subDays, isAfter } from 'date-fns'
import { SortFilterControls, type SortField, type SortDirection, type TimePeriod } from '../components/SortFilterControls'
```

State declarations (after existing state):
```typescript
const [sortField, setSortField] = useSessionState<SortField>('analytics_sortField', 'published_at')
const [sortDirection, setSortDirection] = useSessionState<SortDirection>('analytics_sortDir', 'desc')
const [timePeriod, setTimePeriod] = useSessionState<TimePeriod>('analytics_timePeriod', '30d')
```

Key decisions:
- Storage keys prefixed with `analytics_` to avoid collisions
- Default sortField: 'published_at' (most recent first is intuitive)
- Default sortDirection: 'desc' (newest/highest first)
- Default timePeriod: '30d' (per requirement TIME-02)

Requirements covered:
- SORT-04: Session persistence via useSessionState
- TIME-02: 30d default
  </action>
  <verify>AnalyticsPage imports useSessionState and defines three state variables with session storage keys</verify>
  <done>Sort/filter state is session-persisted with correct defaults (published_at, desc, 30d)</done>
</task>

<task type="auto">
  <name>Task 2: Compute filtered and sorted videos with useMemo</name>
  <files>src/pages/AnalyticsPage.tsx</files>
  <action>
Add useMemo to compute filtered and sorted videos.

Add computed value after state declarations (before the loading check):
```typescript
const filteredAndSortedVideos = useMemo(() => {
  // Step 1: Filter by time period
  let filtered = videos
  if (timePeriod !== 'all') {
    const daysMap: Record<Exclude<TimePeriod, 'all'>, number> = {
      '7d': 7,
      '30d': 30,
      '90d': 90,
    }
    const cutoffDate = subDays(new Date(), daysMap[timePeriod])
    filtered = videos.filter(video =>
      isAfter(new Date(video.published_at), cutoffDate)
    )
  }

  // Step 2: Sort (spread to avoid mutation)
  const sorted = [...filtered].sort((a, b) => {
    let comparison: number
    if (sortField === 'published_at') {
      comparison = new Date(a.published_at).getTime() - new Date(b.published_at).getTime()
    } else {
      comparison = a.view_count - b.view_count
    }
    return sortDirection === 'asc' ? comparison : -comparison
  })

  return sorted
}, [videos, timePeriod, sortField, sortDirection])
```

CRITICAL - Avoid these pitfalls from research:
- Always spread array before sort: `[...filtered].sort()` NOT `filtered.sort()`
- Filter THEN sort (sort applies to filtered subset)
- Dependencies include all state that affects computation

Requirements covered:
- TIME-03: Time filter applies to all analytics (via filtered videos)
  </action>
  <verify>AnalyticsPage has useMemo computing filteredAndSortedVideos with proper dependencies array</verify>
  <done>Videos are filtered by time period and sorted by selected field/direction without mutation</done>
</task>

<task type="auto">
  <name>Task 3: Add Videos section with SortFilterControls</name>
  <files>src/pages/AnalyticsPage.tsx</files>
  <action>
Add a new Videos section below Channel Overview with sort/filter controls.

In the CONTENT STATE section (after Channel Overview section), add:
```tsx
{/* Videos Section */}
<section>
  <h2 className="text-lg font-semibold mb-4 text-[#aaaaaa]">Videos</h2>
  <SortFilterControls
    sortField={sortField}
    sortDirection={sortDirection}
    timePeriod={timePeriod}
    videoCount={filteredAndSortedVideos.length}
    onSortFieldChange={setSortField}
    onSortDirectionChange={setSortDirection}
    onTimePeriodChange={setTimePeriod}
  />

  {/* Video count message when filtered */}
  {filteredAndSortedVideos.length === 0 ? (
    <p className="text-[#aaaaaa] text-center py-8">
      No videos in the selected time period
    </p>
  ) : (
    <div className="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      {filteredAndSortedVideos.map(video => (
        <div
          key={video.id}
          className="bg-[#272727] rounded-lg overflow-hidden"
        >
          <img
            src={video.thumbnail_url}
            alt={video.title}
            className="w-full aspect-video object-cover"
          />
          <div className="p-3">
            <h3 className="font-medium text-sm line-clamp-2 mb-2">{video.title}</h3>
            <div className="flex justify-between text-xs text-[#aaaaaa]">
              <span>{formatViewCount(video.view_count)} views</span>
              <span>{formatRelativeDate(video.published_at)}</span>
            </div>
          </div>
        </div>
      ))}
    </div>
  )}
</section>
```

Import formatters if not already imported:
```typescript
import { formatViewCount, formatRelativeDate } from '../lib/formatters'
```

Requirements covered:
- SORT-01, SORT-02: Via SortFilterControls dropdown
- SORT-03: Via SortFilterControls direction toggle
- SORT-05: Via SortFilterControls visual indication
- TIME-01, TIME-04: Via SortFilterControls time buttons
- TIME-05: videoCount prop shows count in period
  </action>
  <verify>
1. AnalyticsPage renders SortFilterControls component
2. Video grid displays filtered/sorted videos
3. Empty state shown when no videos in period
4. `npm run dev` starts without errors and page renders correctly
  </verify>
  <done>Videos section shows sort/filter controls and displays filtered video grid with proper styling</done>
</task>

</tasks>

<verification>
1. App starts without errors: `npm run dev`
2. Navigate to /analytics - page loads with Channel Overview and Videos sections
3. Change sort field - videos reorder immediately
4. Toggle sort direction - order reverses
5. Click different time periods - video count and list updates
6. Navigate away and back - sort/filter selections persist
7. Close browser tab and reopen - sort/filter reset to defaults (session storage cleared)
</verification>

<success_criteria>
- Sort by date/views works with direction toggle (SORT-01, SORT-02, SORT-03)
- Sort selection persists during session (SORT-04)
- Current sort visually indicated (SORT-05)
- Time period filter works (7d, 30d, 90d, all) (TIME-01)
- 30 days is default (TIME-02)
- Filter applies to videos section (TIME-03)
- Active time period highlighted (TIME-04)
- Video count shows in filter bar (TIME-05)
</success_criteria>

<output>
After completion, create `.planning/phases/07-video-analytics/07-02-SUMMARY.md`
</output>
